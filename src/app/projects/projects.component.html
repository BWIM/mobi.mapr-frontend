<div class="h-full flex flex-col overflow-hidden">
    <p-toast></p-toast>

    <div class="h-full overflow-hidden min-w-0">
        <p-scrollPanel [style]="{width: '100%', height: '100%'}">
            <!-- Gruppierte Projekte -->
            <div class="space-y-4 px-3 min-w-0">
                <div class="mb-4 min-w-0 overflow-hidden" *ngFor="let group of groupedProjects">
                    <p-panel [toggleable]="true" styleClass="overflow-hidden">
                        <ng-template pTemplate="header">
                            <div class="flex items-center">
                                <span><b>{{group.group.name}}</b></span>
                                <button pButton 
                                    *ngIf="!group.group.default"
                                    class="p-button-text p-button-rounded ml-2" 
                                    icon="pi pi-pencil"
                                    (click)="editProjectGroup(group.group)"
                                    pTooltip="{{'PROJECTS.ACTIONS.EDIT_GROUP' | translate}}">
                                </button>
                            </div>
                        </ng-template>
                        <p-table 
                            [value]="group.projects"
                            styleClass="p-datatable-sm"
                            [(selection)]="selectedTableProject"
                            selectionMode="single">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>{{ 'PROJECTS.FIELDS.NAME' | translate }} </th>
                                    <th></th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-project>
                                <tr>
                                    <td>
                                        <div class="flex flex-col">
                                            <div class="flex items-center" [ngClass]="{'selected-row': selectedTableProject?.id === project.id}">
                                                <span class="text-overflow-ellipsis overflow-hidden break-words"
                                                      [pTooltip]="project.display_name + '. (Version: ' + project.version + ')'">
                                                    {{ project.display_name }}
                                                </span>
                                            </div>
                                            <div *ngIf="!project.finished" class="w-full mt-1">
                                                <p-progressBar
                                                    [value]="getProgress(project)" 
                                                    [showValue]="true"
                                                    styleClass="h-1"
                                                    [pTooltip]="progress + '%'"
                                                    color="var(--primary-color)">
                                                </p-progressBar>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-2 justify-end relative">
                                            <p-button 
                                                icon="pi pi-map"
                                                (onClick)="showResults(project)"
                                                [disabled]="!project.finished"
                                                [pTooltip]="'PROJECTS.ACTIONS.SHOW_RESULTS' | translate"
                                                data-tutorial-target="show-results-btn">
                                            </p-button>
                                            <p-button 
                                                icon="pi pi-ellipsis-v"
                                                (click)="menu.toggle($event)"
                                                [disabled]="project.default"
                                                [pTooltip]="'PROJECTS.ACTIONS.MORE_OPTIONS' | translate"
                                                styleClass="p-button-text p-button-rounded">
                                            </p-button>
                                            <p-menu #menu 
                                                [model]="getSpeedDialItems(project)" 
                                                [popup]="true"
                                                appendTo="body">
                                            </p-menu>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </p-panel>
                </div>

                <!-- Nicht gruppierte Projekte -->
                <div class="mb-4 min-w-0 overflow-hidden" *ngIf="ungroupedProjects.length > 0">
                    <p-panel header="{{ 'PROJECTS.UNGROUPED' | translate }}" [toggleable]="true" styleClass="overflow-hidden">
                        <p-table 
                            [value]="ungroupedProjects"
                            styleClass="p-datatable-sm"
                            [(selection)]="selectedTableProject"
                            selectionMode="single">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>{{ 'PROJECTS.FIELDS.NAME' | translate }}</th>
                                    <th></th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-project>
                                <tr>
                                    <td>
                                        <div class="flex flex-col">
                                            <div class="flex items-center" [ngClass]="{'selected-row': selectedTableProject?.id === project.id}">
                                                
                                                <span class="text-overflow-ellipsis overflow-hidden break-words"
                                                      [pTooltip]="project.display_name + '. (Version: ' + project.version + ')'">
                                                    {{ project.display_name }}
                                                </span>
                                            </div>
                                            <div *ngIf="!project.finished" class="w-full mt-1">
                                                <p-progressBar
                                                    [value]="getProgress(project)" 
                                                    [showValue]="true"
                                                    styleClass="h-2"
                                                    [pTooltip]="progress + '%'"
                                                    color="var(--primary-color)">
                                                </p-progressBar>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-2 justify-end relative">
                                            <p-button 
                                                icon="pi pi-map"
                                                (onClick)="showResults(project)"
                                                [disabled]="!project.finished"
                                                [pTooltip]="'PROJECTS.ACTIONS.SHOW_RESULTS' | translate">
                                            </p-button>
                                            <p-button 
                                                icon="pi pi-ellipsis-v"
                                                (click)="menu.toggle($event)"
                                                [disabled]="project.default"
                                                [pTooltip]="'PROJECTS.ACTIONS.MORE_OPTIONS' | translate"
                                                styleClass="p-button-text p-button-rounded">
                                            </p-button>
                                            <p-menu #menu 
                                                [model]="getSpeedDialItems(project)" 
                                                [popup]="true"
                                                appendTo="body">
                                            </p-menu>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </p-panel>
                </div>

                <!-- Keine Projekte -->
                <p-progress-spinner *ngIf="loading" styleClass="w-full h-full"></p-progress-spinner>
                <p-message *ngIf="!loading && groupedProjects.length === 0 && ungroupedProjects.length === 0"
                    severity="info"
                    text="{{ 'PROJECTS.LIST.NO_PROJECTS' | translate }}">
                </p-message>

                <!-- Button für nicht zugewiesene Gruppen -->
                <div class="mt-4 p-2" *ngIf="!loading">
                    <button pButton
                        icon="pi pi-trash"
                        [label]="'PROJECT_GROUPS.MANAGE_UNUSED' | translate"
                        class="p-button-secondary p-button-sm"
                        (click)="showUnusedGroupsOverlay($event)">
                    </button>
                    <div class="flex items-center gap-2 p-2">
                        <p-toggleSwitch [(ngModel)]="autoCloseSidebar"></p-toggleSwitch>
                        <label>{{ 'PROJECTS.AUTO_CLOSE_SIDEBAR' | translate }}</label>
                    </div>
                </div>
            </div>
        </p-scrollPanel>
    </div>

    <!-- Overlay für nicht zugewiesene Gruppen -->
    <p-popover #unusedGroupsOverlay>
        <ng-template pTemplate>
            <div class="flex flex-column gap-3" style="min-width: 300px">
                <h3>{{ 'PROJECT_GROUPS.UNUSED_GROUPS' | translate }}</h3>
                
                <p-message 
                    *ngIf="unusedGroups.length === 0" 
                    severity="info" 
                    [text]="'PROJECT_GROUPS.NO_UNUSED_GROUPS' | translate">
                </p-message>

                <div *ngIf="unusedGroups.length > 0" class="flex flex-column gap-3">
                    <p-listbox 
                        [options]="unusedGroups"
                        [(ngModel)]="selectedUnusedGroups"
                        [multiple]="true"
                        optionLabel="name"
                        [style]="{'max-height': '200px'}"
                        [listStyle]="{'max-height': '200px'}">
                    </p-listbox>

                    <div class="flex justify-content-between align-items-center">
                        <p-button 
                            icon="pi pi-trash" 
                            [label]="'PROJECT_GROUPS.DELETE_SELECTED' | translate"
                            styleClass="p-button-danger p-button-sm"
                            [disabled]="!selectedUnusedGroups.length"
                            (onClick)="confirmDeleteUnusedGroups()">
                        </p-button>
                    </div>
                </div>
            </div>
        </ng-template>
    </p-popover>

    <!-- Action Buttons am unteren Rand -->
    <div class="p-3 bg-surface-ground border-t grid grid-cols-2 gap-2" *ngIf="!loading">
        <p-button 
            icon="pi pi-users" 
            label="{{ 'PROJECTS.ACTIONS.CREATE_GROUP' | translate }}"
            [pTooltip]="'PROJECTS.ACTIONS.CREATE_GROUP_TOOLTIP' | translate"
            styleClass="p-button-secondary w-full"
            (onClick)="showProjectGroupDialog()">
        </p-button>
        <p-button 
            icon="pi pi-plus" 
            label="{{ 'PROJECTS.ACTIONS.CREATE' | translate }}"
            [pTooltip]="'PROJECTS.ACTIONS.CREATE_TOOLTIP' | translate"
            styleClass="p-button-info w-full"
            (onClick)="showProjectWizard()">
        </p-button>
    </div>

    <!-- Edit Project Dialog -->
    <p-dialog 
        [(visible)]="editDialogVisible" 
        [header]="'PROJECTS.EDIT.TITLE' | translate"
        [modal]="true"
        [style]="{width: '450px'}"
        [appendTo]="'body'"
        [draggable]="false"
        [resizable]="false">
        <div class="flex flex-col gap-4" *ngIf="projectToEdit">
            <div class="field">
                <label for="projectName" class="block mb-2">{{ 'PROJECTS.FIELDS.NAME' | translate }}</label>
                <input id="projectName" type="text" pInputText [(ngModel)]="projectToEdit.display_name" class="w-full border p-2 border rounded-md">
            </div>
            
            <div class="field">
                <label for="projectDescription" class="block mb-2">{{ 'PROJECTS.FIELDS.DESCRIPTION' | translate }}</label>
                <textarea id="projectDescription" pInputTextarea [(ngModel)]="projectToEdit.description" class="w-full p-2 border rounded-md" rows="3"></textarea>
            </div>

            <div class="field">
                <label for="projectGroup" class="block mb-2">{{ 'PROJECTS.FIELDS.GROUP' | translate }}</label>
                <p-dropdown 
                    id="projectGroup"
                    [options]="projectGroups"
                    [(ngModel)]="projectToEdit.projectgroup"
                    optionLabel="name"
                    [showClear]="true"
                    [appendTo]="'body'"
                    placeholder="{{ 'PROJECTS.FIELDS.SELECT_GROUP' | translate }}"
                    class="w-full">
                </p-dropdown>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button 
                icon="pi pi-times" 
                (onClick)="closeEditDialog()" 
                label="{{ 'COMMON.ACTIONS.CANCEL' | translate }}"
                [pTooltip]="'COMMON.ACTIONS.CANCEL_TOOLTIP' | translate"
                styleClass="p-button-text">
            </p-button>
            <p-button 
                icon="pi pi-check" 
                (onClick)="saveProject()" 
                label="{{ 'COMMON.ACTIONS.SAVE' | translate }}"
                [pTooltip]="'COMMON.ACTIONS.SAVE_TOOLTIP' | translate">
            </p-button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog 
        [style]="{width: '450px'}" 
        [appendTo]="'body'"
        [header]="'PROJECTS.DELETE.TITLE' | translate"
        [message]="'PROJECTS.DELETE.CONFIRMATION' | translate"
        [icon]="'pi pi-exclamation-triangle'"
        acceptButtonStyleClass="p-button-danger"
        [acceptLabel]="'COMMON.ACTIONS.DELETE' | translate"
        [rejectLabel]="'COMMON.ACTIONS.CANCEL' | translate">
    </p-confirmDialog>

    <!-- Projektgruppen Dialog -->
    <p-dialog 
        [(visible)]="projectGroupDialogVisible" 
        [header]="projectGroupToEdit ? ('PROJECT_GROUPS.EDIT.TITLE' | translate) : ('PROJECT_GROUPS.CREATE.TITLE' | translate)"
        [modal]="true"
        [style]="{width: '450px'}"
        [appendTo]="'body'"
        [draggable]="false"
        [resizable]="false">
        <div class="flex flex-col gap-4">
            <div class="field">
                <label for="groupName" class="block mb-2">{{ 'PROJECT_GROUPS.FIELDS.NAME' | translate }}</label>
                <input id="groupName" 
                    type="text" 
                    pInputText 
                    [(ngModel)]="groupName" 
                    class="w-full border p-2 border rounded-md">
            </div>

            <!-- Lösch-Button für existierende Gruppen -->
            <div class="field" *ngIf="projectGroupToEdit">
                <p-message severity="warn" [text]="'PROJECT_GROUPS.DELETE_WARNING' | translate" styleClass="w-full mb-3"></p-message>
                <button pButton 
                    icon="pi pi-trash" 
                    [label]="'PROJECT_GROUPS.DELETE' | translate"
                    class="p-button-danger w-full"
                    [pTooltip]="'PROJECT_GROUPS.DELETE_TOOLTIP' | translate"
                    (click)="confirmDeleteGroup(projectGroupToEdit)">
                </button>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button 
                icon="pi pi-times" 
                (onClick)="closeProjectGroupDialog()" 
                label="{{ 'COMMON.ACTIONS.CANCEL' | translate }}"
                styleClass="p-button-text">
            </p-button>
            <p-button 
                icon="pi pi-check" 
                (onClick)="saveProjectGroup()" 
                label="{{ 'COMMON.ACTIONS.SAVE' | translate }}">
            </p-button>
        </ng-template>
    </p-dialog>
</div>
